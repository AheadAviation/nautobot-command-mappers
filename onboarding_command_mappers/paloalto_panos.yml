---
# Platform: Palo Alto PAN-OS
# Network Driver: paloalto_panos
# Compatible Versions: PAN-OS 8.0+
#
# IMPORTANT: Connection Timeout Configuration
# ===========================================
# Palo Alto devices may require increased timeouts for prompt detection.
# Add the following to your nautobot_config.py PLUGINS_CONFIG:
#
# "nautobot_device_onboarding": {
#     "netmiko_optional_args": {
#         "read_timeout": 60,  # Increase from default 20s for slow devices
#         "timeout": 90,
#         "banner_timeout": 60,
#         "global_delay_factor": 3,
#         "fast_cli": False,
#     },
# },
#
# Also add to nautobot_plugin_nornir connection_options:
#
# "nautobot_plugin_nornir": {
#     "connection_options": {
#         "netmiko": {
#             "extras": {
#                 "read_timeout": 60,
#                 "read_timeout_override": 60,
#             }
#         }
#     }
# }
#
# After updating config, restart: docker-compose restart nautobot celery_worker
#
# Job Parameter Variables
# =======================
# The following variables should be provided by the job parameters:
# - namespace_name: Namespace name (e.g., "Global") for VRFs and other namespace-dependent objects
# - namespace: Alternative namespace variable (UUID or name) - used as fallback
# - vlan_status_name: Status name for VLANs (e.g., "Active")
# - default_prefix_status_name: Default status name - used as fallback for VLAN status
#
# Hardcoded Values (Platform-Specific)
# =====================================
# - manufacturer: 'Palo Alto Networks' (platform-specific, should remain hardcoded)

sync_devices:
  manufacturer:
    commands:
      - command: "show system info"
        parser: "raw"
        jpath: "@"
        post_processor: "Palo Alto Networks"

  model:
    commands:
      - command: "show system info"
        parser: "raw"
        jpath: "@"
        post_processor: |
          {%- set raw_obj = obj.get('raw', obj) if obj is mapping else obj -%}
          {%- set lines = raw_obj.replace('\r', '').split('\n') -%}
          {%- set ns = namespace(result='') -%}
          {%- for line in lines -%}
            {%- if 'model:' in line.lower() and not ns.result -%}
              {%- set parts = line.split(':', 1) -%}
              {%- if parts | length > 1 -%}
                {%- set ns.result = parts[1].strip() -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.result }}

  device_type:
    commands:
      - command: "show system info"
        parser: "raw"
        jpath: "@"
        post_processor: |
          {%- set raw_obj = obj.get('raw', obj) if obj is mapping else obj -%}
          {%- set lines = raw_obj.replace('\r', '').split('\n') -%}
          {%- set manufacturer = 'Palo Alto Networks' -%}
          {%- set ns = namespace(model='') -%}
          {%- for line in lines -%}
            {%- if 'model:' in line.lower() and not ns.model -%}
              {%- set parts = line.split(':', 1) -%}
              {%- if parts | length > 1 -%}
                {%- set ns.model = parts[1].strip() -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if ns.model -%}
            {{ manufacturer }} {{ ns.model }}
          {%- else -%}
            {{ manufacturer }}
          {%- endif -%}

  platform:
    commands:
      - command: "show system info"
        parser: "raw"
        jpath: "@"
        post_processor: "paloalto_panos"

  version:
    commands:
      - command: "show system info"
        parser: "raw"
        jpath: "@"
        post_processor: |
          {%- set raw_obj = obj.get('raw', obj) if obj is mapping else obj -%}
          {%- set lines = raw_obj.replace('\r', '').split('\n') -%}
          {%- set ns = namespace(result='') -%}
          {%- for line in lines -%}
            {%- if 'sw-version:' in line.lower() and not ns.result -%}
              {%- set parts = line.split(':', 1) -%}
              {%- if parts | length > 1 -%}
                {%- set ns.result = parts[1].strip() -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.result }}

  hostname:
    commands:
      - command: "show system info"
        parser: "raw"
        jpath: "@"
        post_processor: |
          {%- set raw_obj = obj.get('raw', obj) if obj is mapping else obj -%}
          {%- set lines = raw_obj.replace('\r', '').split('\n') -%}
          {%- set ns = namespace(result='') -%}
          {%- for line in lines -%}
            {%- if 'hostname:' in line.lower() and not ns.result -%}
              {%- set parts = line.split(':', 1) -%}
              {%- if parts | length > 1 -%}
                {%- set ns.result = parts[1].strip() -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.result }}

  serial:
    commands:
      - command: "show system info"
        parser: "raw"
        jpath: "@"
        post_processor: |
          {%- set raw_obj = obj.get('raw', obj) if obj is mapping else obj -%}
          {%- set lines = raw_obj.replace('\r', '').split('\n') -%}
          {%- set ns = namespace(result='') -%}
          {%- for line in lines -%}
            {%- if 'serial:' in line.lower() and not ns.result -%}
              {%- set parts = line.split(':', 1) -%}
              {%- if parts | length > 1 -%}
                {%- set ns.result = parts[1].strip() -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.result }}

  mgmt_ip:
    commands:
      - command: "show system info"
        parser: "raw"
        jpath: "@"
        post_processor: |
          {%- set raw_obj = obj.get('raw', obj) if obj is mapping else obj -%}
          {%- set lines = raw_obj.replace('\r', '').split('\n') -%}
          {%- set ns = namespace(result='') -%}
          {%- for line in lines -%}
            {%- if 'ip-address:' in line.lower() and not ns.result -%}
              {%- set parts = line.split(':', 1) -%}
              {%- if parts | length > 1 -%}
                {%- set ip_part = parts[1].strip() -%}
                {%- if '/' in ip_part -%}
                  {%- set ns.result = ip_part.split('/')[0].strip() -%}
                {%- else -%}
                  {%- set ns.result = ip_part -%}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.result }}

  mgmt_interface:
    commands:
      - command: "show system info"
        parser: "raw"
        jpath: "@"
        post_processor: "mgmt"

  mask_length:
    commands:
      - command: "show system info"
        parser: "raw"
        jpath: "@"
        iterable_type: "int"
        post_processor: |
          {%- set raw_obj = obj.get('raw', obj) if obj is mapping else obj -%}
          {%- set lines = raw_obj.replace('\r', '').split('\n') -%}
          {%- set ns = namespace(result='') -%}
          {%- for line in lines -%}
            {%- if 'ip-address:' in line.lower() and not ns.result -%}
              {%- set parts = line.split(':', 1) -%}
              {%- if parts | length > 1 -%}
                {%- set ip_part = parts[1].strip() -%}
                {%- if '/' in ip_part -%}
                  {%- set ns.result = ip_part.split('/')[1].strip() -%}
                {%- else -%}
                  {%- set ns.result = '24' -%}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.result if ns.result else '24' }}

sync_network_data:
  serial:
    commands:
      - command: "show system info"
        parser: "raw"
        jpath: "raw"
        post_processor: |
          {%- set lines = obj.replace('\r', '').split('\n') -%}
          {%- for line in lines -%}
            {%- if 'serial:' in line.lower() and ':' in line -%}
              {{ line.split(':', 1)[1].strip() }}
            {%- endif -%}
          {%- endfor -%}

  software_version:
    commands:
      - command: "show system info"
        parser: "raw"
        jpath: "raw"
        post_processor: |
          {%- set lines = obj.replace('\r', '').split('\n') -%}
          {%- set ns = namespace(result='unknown') -%}
          {%- for line in lines -%}
            {%- if 'sw-version:' in line.lower() and ns.result == 'unknown' -%}
              {%- set parts = line.split(':', 1) -%}
              {%- if parts | length > 1 -%}
                {%- set ns.result = parts[1].strip() -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.result }}

  cables:
    commands:
      - command: "show lldp neighbors all"
        parser: "raw"
        jpath: "raw"
        post_processor: |
          {%- set lines = obj.replace('\r', '').split('\n') -%}
          {%- set cables = [] -%}
          {# Simple LLDP parser #}
          {%- set ns = namespace(local_port=none) -%}
          {%- for line in lines -%}
            {%- if 'Local Interface:' in line -%}
              {%- set ns.local_port = line.split(':', 1)[1].strip() -%}
            {%- elif 'Port ID:' in line and ns.local_port -%}
              {%- set remote_port = line.split(':', 1)[1].strip() -%}
            {%- elif 'System Name:' in line and ns.local_port -%}
              {%- set remote_device = line.split(':', 1)[1].strip() -%}
              {%- set _ = cables.append({
                "local_interface": ns.local_port,
                "remote_interface": remote_port,
                "remote_device": remote_device
              }) -%}
              {%- set ns.local_port = none -%}
            {%- endif -%}
          {%- endfor -%}
          {{ cables | tojson }}

  vrfs:
    commands:
      - command: "show config merged"
        parser: "raw"
        jpath: "raw"
        post_processor: |
          {%- set lines = obj.replace('\r', '').split('\n') -%}
          {%- set vrfs = {} -%}
          {%- set ns = namespace(in_vr=false, level=0, vr_level=-1, current_vr=none) -%}
          {%- for line in lines -%}
            {%- set stripped = line.strip() -%}
            {%- if stripped.endswith('{') -%}
              {%- set ns.level = ns.level + 1 -%}
              {%- if 'virtual-router {' in stripped -%}
                {%- set ns.in_vr = true -%}
                {%- set ns.vr_level = ns.level -%}
              {%- elif ns.in_vr and ns.level == ns.vr_level + 1 -%}
                {%- set ns.current_vr = stripped.split('{')[0].strip() -%}
                {%- if ns.current_vr not in vrfs -%}
                  {# Use namespace from job parameters, fallback to None if not provided #}
                  {%- set vrf_namespace = namespace_name | default(namespace | default(none)) -%}
                  {%- set _ = vrfs.update({ns.current_vr: {"name": ns.current_vr, "namespace": vrf_namespace, "description": "Imported from Palo Alto"}}) -%}
                {%- endif -%}
              {%- endif -%}
            {%- elif stripped.endswith('}') -%}
              {%- if ns.level == ns.vr_level -%}
                {%- set ns.in_vr = false -%}
                {%- set ns.vr_level = -1 -%}
              {%- elif ns.level == ns.vr_level + 1 -%}
                {%- set ns.current_vr = none -%}
              {%- endif -%}
              {%- set ns.level = ns.level - 1 -%}
            {%- endif -%}
          {%- endfor -%}
          {{ vrfs | tojson }}

  vlans:
    commands:
      - command: "show config merged"
        parser: "raw"
        jpath: "raw"
        post_processor: |
          {%- set lines = obj.replace('\r', '').split('\n') -%}
          {%- set vlans = {} -%}
          {%- for line in lines -%}
            {%- set stripped = line.strip() -%}
            {%- if 'tag ' in stripped and stripped.endswith(';') -%}
              {%- set parts = stripped.rstrip(';').split() -%}
              {%- if parts[0] == 'tag' -%}
                {%- set tag = parts[1] | int(default=-1) -%}
                {%- if tag > 0 and tag < 4095 -%}
                  {%- set tag_str = tag | string -%}
                  {%- if tag_str not in vlans -%}
                    {# Use status from job parameters, fallback to None if not provided #}
                    {# Explicitly set locations to empty list to prevent automatic location assignment #}
                    {%- set vlan_status = vlan_status_name | default(default_prefix_status_name | default(none)) -%}
                    {%- set _ = vlans.update({tag_str: {"vid": tag, "name": "VLAN" ~ tag_str, "status": vlan_status, "locations": []}}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ vlans | tojson }}

  interfaces:
    commands:
      - command: "show config merged"
        parser: "raw"
        jpath: "raw"
        post_processor: |
          {%- set lines = obj.replace('\r', '').split('\n') -%}
          {%- set ns = namespace(
              config_interfaces={},
              all_interfaces=[],
              vrf_map={},
              brace_level=0,
              in_interface=false,
              interface_brace_level=-1,
              in_ethernet=false,
              ethernet_brace_level=-1,
              in_loopback=false,
              loopback_brace_level=-1,
              in_tunnel=false,
              tunnel_brace_level=-1,
              in_aggregate=false,
              aggregate_brace_level=-1,
              in_deviceconfig=false,
              deviceconfig_brace_level=-1,
              in_system=false,
              system_brace_level=-1,
              in_virtual_router=false,
              vr_brace_level=-1,
              current_vr=none,
              in_layer3=false,
              in_units=false,
              current_iface=none,
              current_subiface=none,
              expect_ip_value=false,
              mgmt_ip=none,
              mgmt_mask=none,
              untagged_subinterface_enabled=false,
              mtu_map={},
              jumbo_frame_enabled=false
          ) -%}
          {# Parse hierarchical config format using brace-level tracking #}
          {%- for line in lines -%}
            {%- set stripped = line.strip() -%}
            {%- if stripped -%}
              {%- set parts = stripped.rstrip('{').rstrip('}').rstrip(';').strip().split() -%}
              {%- if stripped.endswith('{') and parts | length > 0 -%}
                {# Opening brace - increment level first #}
                {%- set ns.brace_level = ns.brace_level + 1 -%}
                {%- set key = parts[0] -%}
                {# Track interface block (parent of ethernet, loopback, tunnel, etc.) #}
                {%- if key == 'interface' and not ns.in_interface -%}
                  {%- set ns.in_interface = true -%}
                  {%- set ns.interface_brace_level = ns.brace_level -%}
                {# Track ethernet block under interface #}
                {%- elif key == 'ethernet' and ns.in_interface and ns.brace_level == ns.interface_brace_level + 1 -%}
                  {%- set ns.in_ethernet = true -%}
                  {%- set ns.ethernet_brace_level = ns.brace_level -%}
                {# Track loopback block under interface #}
                {%- elif key == 'loopback' and ns.in_interface and ns.brace_level == ns.interface_brace_level + 1 -%}
                  {%- set ns.in_loopback = true -%}
                  {%- set ns.loopback_brace_level = ns.brace_level -%}
                {# Track tunnel block under interface #}
                {%- elif key == 'tunnel' and ns.in_interface and ns.brace_level == ns.interface_brace_level + 1 -%}
                  {%- set ns.in_tunnel = true -%}
                  {%- set ns.tunnel_brace_level = ns.brace_level -%}
                {# Track aggregate-ethernet block under interface #}
                {%- elif key == 'aggregate-ethernet' and ns.in_interface and ns.brace_level == ns.interface_brace_level + 1 -%}
                  {%- set ns.in_aggregate = true -%}
                  {%- set ns.aggregate_brace_level = ns.brace_level -%}
                {# Physical ethernet interface: ethernet1/1 { (direct child of ethernet block) #}
                {%- elif ns.in_ethernet and ns.brace_level == ns.ethernet_brace_level + 1 -%}
                  {%- set potential_name = key -%}
                  {%- set has_dash = '-' in potential_name -%}
                  {%- if not has_dash and potential_name.startswith('ethernet') and '/' in potential_name and '.' not in potential_name -%}
                    {%- if potential_name not in ns.all_interfaces -%}
                      {%- set _ = ns.all_interfaces.append(potential_name) -%}
                    {%- endif -%}
                    {%- if potential_name not in ns.config_interfaces -%}
                      {%- set _ = ns.config_interfaces.update({potential_name: {'ip_addresses': [], 'vlan_tag': none}}) -%}
                    {%- endif -%}
                    {%- set ns.current_iface = potential_name -%}
                    {%- set ns.current_subiface = none -%}
                    {%- set ns.in_layer3 = false -%}
                    {%- set ns.in_units = false -%}
                  {%- endif -%}
                {# Loopback interface: loopback.1 { (direct child of loopback block under units) #}
                {%- elif ns.in_loopback and ns.in_units and '.' in key and key.startswith('loopback') -%}
                  {%- set potential_name = key -%}
                  {%- if potential_name not in ns.all_interfaces -%}
                    {%- set _ = ns.all_interfaces.append(potential_name) -%}
                  {%- endif -%}
                  {%- if potential_name not in ns.config_interfaces -%}
                    {%- set _ = ns.config_interfaces.update({potential_name: {'ip_addresses': [], 'vlan_tag': none}}) -%}
                  {%- endif -%}
                  {%- set ns.current_iface = potential_name -%}
                  {%- set ns.current_subiface = none -%}
                {# Tunnel interface: tunnel.1 { (direct child of tunnel block under units) #}
                {%- elif ns.in_tunnel and ns.in_units and '.' in key and key.startswith('tunnel') -%}
                  {%- set potential_name = key -%}
                  {%- if potential_name not in ns.all_interfaces -%}
                    {%- set _ = ns.all_interfaces.append(potential_name) -%}
                  {%- endif -%}
                  {%- if potential_name not in ns.config_interfaces -%}
                    {%- set _ = ns.config_interfaces.update({potential_name: {'ip_addresses': [], 'vlan_tag': none}}) -%}
                  {%- endif -%}
                  {%- set ns.current_iface = potential_name -%}
                  {%- set ns.current_subiface = none -%}
                {# Aggregate interface: ae1 { (direct child of aggregate-ethernet block) #}
                {%- elif ns.in_aggregate and ns.brace_level == ns.aggregate_brace_level + 1 -%}
                  {%- set potential_name = key -%}
                  {%- set ae_suffix = potential_name[2:] if potential_name | length > 2 else 'x' -%}
                  {%- if potential_name.startswith('ae') and (ae_suffix | int(default=-1) >= 0) -%}
                    {%- if potential_name not in ns.all_interfaces -%}
                      {%- set _ = ns.all_interfaces.append(potential_name) -%}
                    {%- endif -%}
                    {%- if potential_name not in ns.config_interfaces -%}
                      {%- set _ = ns.config_interfaces.update({potential_name: {'ip_addresses': [], 'vlan_tag': none}}) -%}
                    {%- endif -%}
                    {%- set ns.current_iface = potential_name -%}
                    {%- set ns.current_subiface = none -%}
                    {%- set ns.in_layer3 = false -%}
                    {%- set ns.in_units = false -%}
                  {%- endif -%}
                {# layer3 block under physical interface #}
                {%- elif key == 'layer3' and ns.current_iface -%}
                  {%- set ns.in_layer3 = true -%}
                  {%- set ns.in_units = false -%}
                {# units block under layer3 (contains subinterfaces) or under loopback/tunnel #}
                {%- elif key == 'units' -%}
                  {%- set ns.in_units = true -%}
                {# ip block - next line will have the IP address #}
                {%- elif key == 'ip' and (ns.current_iface or ns.current_subiface) -%}
                  {%- set ns.expect_ip_value = true -%}
                {# Subinterface under units: ethernet1/12.10 { #}
                {%- elif ns.in_units and ns.in_layer3 -%}
                  {%- set potential_subif = key -%}
                  {%- set has_dash_subif = '-' in potential_subif -%}
                  {%- if not has_dash_subif and '.' in potential_subif and (potential_subif.startswith('ethernet') or potential_subif.startswith('ae')) -%}
                    {%- if potential_subif not in ns.all_interfaces -%}
                      {%- set _ = ns.all_interfaces.append(potential_subif) -%}
                    {%- endif -%}
                    {%- if potential_subif not in ns.config_interfaces -%}
                      {%- set _ = ns.config_interfaces.update({potential_subif: {'ip_addresses': [], 'vlan_tag': none}}) -%}
                    {%- endif -%}
                    {%- set ns.current_subiface = potential_subif -%}
                  {%- endif -%}
                {# deviceconfig block for management interface #}
                {%- elif key == 'deviceconfig' -%}
                  {%- set ns.in_deviceconfig = true -%}
                  {%- set ns.deviceconfig_brace_level = ns.brace_level -%}
                {%- elif key == 'system' and ns.in_deviceconfig and ns.brace_level == ns.deviceconfig_brace_level + 1 -%}
                  {%- set ns.in_system = true -%}
                  {%- set ns.system_brace_level = ns.brace_level -%}
                {# virtual-router block for VRF mapping #}
                {%- elif key == 'virtual-router' -%}
                  {%- set ns.in_virtual_router = true -%}
                  {%- set ns.vr_brace_level = ns.brace_level -%}
                {# Virtual router name (direct child of virtual-router block) #}
                {%- elif ns.in_virtual_router and ns.brace_level == ns.vr_brace_level + 1 -%}
                  {%- set ns.current_vr = key -%}
                {%- endif -%}
              {%- elif stripped.endswith('}') -%}
                {# Closing brace - check if exiting blocks before decrementing #}
                {%- if ns.in_interface and ns.brace_level == ns.interface_brace_level -%}
                  {%- set ns.in_interface = false -%}
                  {%- set ns.interface_brace_level = -1 -%}
                  {%- set ns.in_ethernet = false -%}
                  {%- set ns.ethernet_brace_level = -1 -%}
                  {%- set ns.in_loopback = false -%}
                  {%- set ns.loopback_brace_level = -1 -%}
                  {%- set ns.in_tunnel = false -%}
                  {%- set ns.tunnel_brace_level = -1 -%}
                  {%- set ns.in_aggregate = false -%}
                  {%- set ns.aggregate_brace_level = -1 -%}
                {%- endif -%}
                {%- if ns.in_ethernet and ns.brace_level == ns.ethernet_brace_level -%}
                  {%- set ns.in_ethernet = false -%}
                  {%- set ns.ethernet_brace_level = -1 -%}
                  {%- set ns.current_iface = none -%}
                  {%- set ns.current_subiface = none -%}
                  {%- set ns.in_layer3 = false -%}
                  {%- set ns.in_units = false -%}
                {%- endif -%}
                {%- if ns.in_loopback and ns.brace_level == ns.loopback_brace_level -%}
                  {%- set ns.in_loopback = false -%}
                  {%- set ns.loopback_brace_level = -1 -%}
                  {%- set ns.in_units = false -%}
                {%- endif -%}
                {%- if ns.in_tunnel and ns.brace_level == ns.tunnel_brace_level -%}
                  {%- set ns.in_tunnel = false -%}
                  {%- set ns.tunnel_brace_level = -1 -%}
                  {%- set ns.in_units = false -%}
                {%- endif -%}
                {%- if ns.in_aggregate and ns.brace_level == ns.aggregate_brace_level -%}
                  {%- set ns.in_aggregate = false -%}
                  {%- set ns.aggregate_brace_level = -1 -%}
                {%- endif -%}
                {%- if ns.in_system and ns.brace_level == ns.system_brace_level -%}
                  {%- set ns.in_system = false -%}
                  {%- set ns.system_brace_level = -1 -%}
                {%- endif -%}
                {%- if ns.in_deviceconfig and ns.brace_level == ns.deviceconfig_brace_level -%}
                  {%- set ns.in_deviceconfig = false -%}
                  {%- set ns.deviceconfig_brace_level = -1 -%}
                  {%- set ns.in_system = false -%}
                  {%- set ns.system_brace_level = -1 -%}
                {%- endif -%}
                {%- if ns.in_virtual_router and ns.brace_level == ns.vr_brace_level -%}
                  {%- set ns.in_virtual_router = false -%}
                  {%- set ns.vr_brace_level = -1 -%}
                  {%- set ns.current_vr = none -%}
                {%- endif -%}
                {%- if ns.brace_level > 0 -%}
                  {%- set ns.brace_level = ns.brace_level - 1 -%}
                {%- endif -%}
                {%- set ns.expect_ip_value = false -%}
              {%- elif stripped.endswith(';') and parts | length > 0 -%}
                {# Value line #}
                {%- if ns.expect_ip_value -%}
                  {# IP address value: 10.0.0.254/24; #}
                  {%- set ip_cidr = parts[0] -%}
                  {%- if '/' in ip_cidr -%}
                    {%- set ip_parts = ip_cidr.split('/') -%}
                    {%- set ip_addr = ip_parts[0] -%}
                    {%- set prefix = ip_parts[1] | int -%}
                    {%- set target = ns.current_subiface if ns.current_subiface else ns.current_iface -%}
                    {%- if target and target in ns.config_interfaces -%}
                      {%- set _ = ns.config_interfaces[target]['ip_addresses'].append({'ip_address': ip_addr, 'prefix_length': prefix}) -%}
                    {%- endif -%}
                  {%- endif -%}
                  {%- set ns.expect_ip_value = false -%}
                {%- elif parts | length >= 2 and parts[0] == 'tag' and ns.current_subiface -%}
                  {# VLAN tag: tag 1; #}
                  {%- set vlan_tag = parts[1] | int -%}
                  {%- if vlan_tag > 0 and ns.current_subiface in ns.config_interfaces -%}
                    {%- set _ = ns.config_interfaces[ns.current_subiface].update({'vlan_tag': vlan_tag}) -%}
                  {%- endif -%}
                {%- elif parts | length >= 2 and parts[0] == 'untagged-sub-interface' and parts[1] == 'yes' and ns.in_layer3 and ns.current_iface -%}
                  {# Untagged subinterface mode enabled: untagged-sub-interface yes; #}
                  {%- if ns.current_iface not in ns.config_interfaces -%}
                    {%- set _ = ns.config_interfaces.update({ns.current_iface: {'ip_addresses': [], 'vlan_tag': none, 'untagged_subinterface': true}}) -%}
                  {%- else -%}
                    {%- set _ = ns.config_interfaces[ns.current_iface].update({'untagged_subinterface': true}) -%}
                  {%- endif -%}
                {%- elif parts | length >= 2 and parts[0] == 'mtu' and (ns.current_iface or ns.current_subiface) -%}
                  {# MTU value: mtu 9216; #}
                  {%- set mtu_value = parts[1] | int(default=1500) -%}
                  {%- set target = ns.current_subiface if ns.current_subiface else ns.current_iface -%}
                  {%- if target -%}
                    {%- set _ = ns.mtu_map.update({target: mtu_value}) -%}
                  {%- endif -%}
                {%- elif parts | length >= 2 and parts[0] == 'jumbo-frame' and parts[1] == 'yes' -%}
                  {# Global jumbo frame setting: jumbo-frame yes; #}
                  {%- set ns.jumbo_frame_enabled = true -%}
                {%- elif ns.in_system and parts | length >= 2 and parts[0] == 'ip-address' -%}
                  {# Management IP: ip-address 192.168.11.16; #}
                  {%- set ns.mgmt_ip = parts[1] -%}
                {%- elif ns.in_system and parts | length >= 2 and parts[0] == 'netmask' -%}
                  {# Management netmask: netmask 255.255.255.0; #}
                  {%- set ns.mgmt_mask = parts[1] -%}
                {%- elif ns.current_vr and parts[0] == 'interface' -%}
                  {# VRF interface assignment: interface [ eth1/1 eth1/2 ]; or interface eth1/1; #}
                  {# Handle both array format and single interface format #}
                  {%- set iface_list = [] -%}
                  {%- for p in parts[1:] -%}
                    {%- set cleaned = p.replace('[', '').replace(']', '').strip() -%}
                    {%- if cleaned and cleaned not in ['[', ']'] -%}
                      {%- set _ = iface_list.append(cleaned) -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- for iface in iface_list -%}
                    {%- set _ = ns.vrf_map.update({iface: ns.current_vr}) -%}
                  {%- endfor -%}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {# Add management interface if found #}
          {%- if ns.mgmt_ip and ns.mgmt_mask -%}
            {%- if 'mgmt' not in ns.all_interfaces -%}
              {%- set _ = ns.all_interfaces.append('mgmt') -%}
            {%- endif -%}
            {%- set octets = ns.mgmt_mask.split('.') -%}
            {%- set prefix_bits = 0 -%}
            {# Convert each octet to bits (unrolled loop since Jinja2 can't accumulate in loops) #}
            {%- if octets | length >= 1 -%}
              {%- set val = octets[0] | int -%}
              {%- if val == 255 -%}{%- set prefix_bits = prefix_bits + 8 -%}
              {%- elif val == 254 -%}{%- set prefix_bits = prefix_bits + 7 -%}
              {%- elif val == 252 -%}{%- set prefix_bits = prefix_bits + 6 -%}
              {%- elif val == 248 -%}{%- set prefix_bits = prefix_bits + 5 -%}
              {%- elif val == 240 -%}{%- set prefix_bits = prefix_bits + 4 -%}
              {%- elif val == 224 -%}{%- set prefix_bits = prefix_bits + 3 -%}
              {%- elif val == 192 -%}{%- set prefix_bits = prefix_bits + 2 -%}
              {%- elif val == 128 -%}{%- set prefix_bits = prefix_bits + 1 -%}
              {%- endif -%}
            {%- endif -%}
            {%- if octets | length >= 2 -%}
              {%- set val = octets[1] | int -%}
              {%- if val == 255 -%}{%- set prefix_bits = prefix_bits + 8 -%}
              {%- elif val == 254 -%}{%- set prefix_bits = prefix_bits + 7 -%}
              {%- elif val == 252 -%}{%- set prefix_bits = prefix_bits + 6 -%}
              {%- elif val == 248 -%}{%- set prefix_bits = prefix_bits + 5 -%}
              {%- elif val == 240 -%}{%- set prefix_bits = prefix_bits + 4 -%}
              {%- elif val == 224 -%}{%- set prefix_bits = prefix_bits + 3 -%}
              {%- elif val == 192 -%}{%- set prefix_bits = prefix_bits + 2 -%}
              {%- elif val == 128 -%}{%- set prefix_bits = prefix_bits + 1 -%}
              {%- endif -%}
            {%- endif -%}
            {%- if octets | length >= 3 -%}
              {%- set val = octets[2] | int -%}
              {%- if val == 255 -%}{%- set prefix_bits = prefix_bits + 8 -%}
              {%- elif val == 254 -%}{%- set prefix_bits = prefix_bits + 7 -%}
              {%- elif val == 252 -%}{%- set prefix_bits = prefix_bits + 6 -%}
              {%- elif val == 248 -%}{%- set prefix_bits = prefix_bits + 5 -%}
              {%- elif val == 240 -%}{%- set prefix_bits = prefix_bits + 4 -%}
              {%- elif val == 224 -%}{%- set prefix_bits = prefix_bits + 3 -%}
              {%- elif val == 192 -%}{%- set prefix_bits = prefix_bits + 2 -%}
              {%- elif val == 128 -%}{%- set prefix_bits = prefix_bits + 1 -%}
              {%- endif -%}
            {%- endif -%}
            {%- if octets | length >= 4 -%}
              {%- set val = octets[3] | int -%}
              {%- if val == 255 -%}{%- set prefix_bits = prefix_bits + 8 -%}
              {%- elif val == 254 -%}{%- set prefix_bits = prefix_bits + 7 -%}
              {%- elif val == 252 -%}{%- set prefix_bits = prefix_bits + 6 -%}
              {%- elif val == 248 -%}{%- set prefix_bits = prefix_bits + 5 -%}
              {%- elif val == 240 -%}{%- set prefix_bits = prefix_bits + 4 -%}
              {%- elif val == 224 -%}{%- set prefix_bits = prefix_bits + 3 -%}
              {%- elif val == 192 -%}{%- set prefix_bits = prefix_bits + 2 -%}
              {%- elif val == 128 -%}{%- set prefix_bits = prefix_bits + 1 -%}
              {%- endif -%}
            {%- endif -%}
            {%- set _ = ns.config_interfaces.update({'mgmt': {'ip_addresses': [{'ip_address': ns.mgmt_ip, 'prefix_length': prefix_bits}], 'vlan_tag': none}}) -%}
          {%- endif -%}
          {# Build interfaces dictionary from config data #}
          {%- set interfaces = {} -%}
          {# First pass: identify parent interfaces that have subinterfaces #}
          {%- set parent_interfaces = [] -%}
          {%- for name in ns.all_interfaces -%}
            {%- if '.' in name -%}
              {# This is a subinterface, extract parent name #}
              {%- set parent = name.split('.')[0] -%}
              {%- if parent not in parent_interfaces -%}
                {%- set _ = parent_interfaces.append(parent) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {# Second pass: build interface dictionaries #}
          {%- for name in ns.all_interfaces | sort -%}
            {# Skip meaningless virtual/system interfaces #}
            {%- if name not in ['vlan', 'tunnel', 'loopback', 'name'] -%}
              {%- set is_sub = '.' in name -%}
              {%- set is_parent = name in parent_interfaces -%}
              {%- set config = ns.config_interfaces.get(name, {}) -%}
              {# Determine interface type dynamically based on naming convention #}
              {%- set iface_type = 'other' -%}
              {%- if is_sub -%}
                {%- set iface_type = 'virtual' -%}
              {%- elif 'ethernet' in name.lower() and '/' in name -%}
                {%- set iface_type = '1000base-t' -%}
              {%- elif name.startswith('ae') -%}
                {%- set iface_type = 'lag' -%}
              {%- elif 'loopback' in name.lower() -%}
                {%- set iface_type = 'virtual' -%}
              {%- elif 'tunnel' in name.lower() -%}
                {%- set iface_type = 'virtual' -%}
              {%- elif name == 'mgmt' -%}
                {%- set iface_type = '1000base-t' -%}
              {%- endif -%}
              {# Get IP addresses from config #}
              {%- set ip_addresses = config.get('ip_addresses', []) -%}
              {# Determine LAG parent for subinterfaces #}
              {%- set lag_parent = '' -%}
              {%- if is_sub -%}
                {%- set parent_name = name.split('.')[0] -%}
                {%- if parent_name.startswith('ae') -%}
                  {%- set lag_parent = parent_name -%}
                {%- endif -%}
              {%- endif -%}
              {# Get MTU from config or use defaults #}
              {%- set iface_mtu = ns.mtu_map.get(name, none) -%}
              {%- if not iface_mtu -%}
                {# Default to 9216 if jumbo frames enabled globally, else 1500 #}
                {%- set iface_mtu = '9216' if ns.jumbo_frame_enabled else '1500' -%}
              {%- else -%}
                {%- set iface_mtu = iface_mtu | string -%}
              {%- endif -%}
              {# Get VRF from vrf_map if available #}
              {# VRF must be a dictionary with 'name' and 'namespace' keys #}
              {%- set vrf_name = ns.vrf_map.get(name, none) -%}
              {# If not found, check parent interface for VRF (for subinterfaces) #}
              {%- if not vrf_name and is_sub -%}
                {%- set parent_name = name.split('.')[0] -%}
                {%- set vrf_name = ns.vrf_map.get(parent_name, none) -%}
              {%- endif -%}
              {# Convert VRF name to dictionary format expected by plugin #}
              {# Use namespace from job parameters, fallback to None if not provided #}
              {%- set vrf_namespace = namespace_name | default(namespace | default(none)) -%}
              {%- set iface_vrf = {"name": vrf_name, "namespace": vrf_namespace} if vrf_name else none -%}
              {# Determine 802.1Q mode and VLAN assignments #}
              {%- set dot1q_mode = '' -%}
              {%- set untagged_vlan = none -%}
              {%- set tagged_vlans = [] -%}
              {%- if is_sub -%}
                {# Subinterface logic #}
                {%- set parent_name = name.split('.')[0] -%}
                {%- set parent_config = ns.config_interfaces.get(parent_name, {}) -%}
                {%- if parent_config.get('untagged_subinterface', false) -%}
                  {# Untagged subinterface mode enabled on parent - subinterface handles untagged traffic #}
                  {%- set dot1q_mode = 'access' -%}
                  {# If subinterface has a tag, use it as the untagged VLAN #}
                  {%- if config.get('vlan_tag') -%}
                    {%- set tag = config.get('vlan_tag') -%}
                    {%- set untagged_vlan = {"name": "VLAN" ~ tag, "id": tag | string} -%}
                  {%- endif -%}
                {%- elif config.get('vlan_tag') -%}
                  {# Tagged subinterface - access mode with VLAN tag #}
                  {%- set dot1q_mode = 'access' -%}
                  {%- set tag = config.get('vlan_tag') -%}
                  {%- set untagged_vlan = {"name": "VLAN" ~ tag, "id": tag | string} -%}
                {%- else -%}
                  {# Subinterface without tag - access mode #}
                  {%- set dot1q_mode = 'access' -%}
                {%- endif -%}
              {%- elif is_parent -%}
                {# Physical interface with subinterfaces - tagged/trunk mode #}
                {%- set dot1q_mode = 'tagged' -%}
                {# Collect all VLAN tags from subinterfaces #}
                {%- for sub_name in ns.all_interfaces -%}
                  {%- if sub_name.startswith(name ~ '.') -%}
                    {%- set sub_config = ns.config_interfaces.get(sub_name, {}) -%}
                    {%- set stag = sub_config.get('vlan_tag') -%}
                    {%- if stag -%}
                      {%- set _ = tagged_vlans.append({"name": "VLAN" ~ stag, "id": stag | string}) -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endfor -%}
              {%- endif -%}
              {# Build interface dict with required SSoT fields #}
              {%- set iface_dict = {
                'type': iface_type,
                'mac_address': none,
                'mtu': iface_mtu,
                'description': '',
                'link_status': true,
                'ip_addresses': ip_addresses,
                'tagged_vlans': tagged_vlans,
                'untagged_vlan': untagged_vlan,
                'lag': lag_parent,
                'vrf': iface_vrf,
                '802.1Q_mode': dot1q_mode
              } -%}
              {# Add mgmt_only flag for management interface #}
              {%- if name == 'mgmt' -%}
                {%- set _ = iface_dict.update({'mgmt_only': true}) -%}
              {%- endif -%}
              {%- set _ = interfaces.update({name: iface_dict}) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ interfaces | tojson }}
